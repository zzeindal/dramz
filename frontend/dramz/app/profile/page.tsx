'use client'

import { useState, useEffect } from 'react'
import { useSelector, useDispatch } from 'react-redux'
import { useRouter, useSearchParams } from 'next/navigation'
import { RootState } from '../state/store'
import BottomSheet from '../components/BottomSheet'
import CrownIcon from '../components/CrownIcon'
import TransactionDetailModal from '../components/TransactionDetailModal'
import SettingsIcon from '../components/SettingsIcon'
import { useTranslation } from '../hooks/useTranslation'
import { languageNames } from '../i18n'
import { useSeriesList } from '@/hooks/useSeriesList'
import { API_BASE_URL } from '@/lib/api/client'
import { openModal } from '../state/slices/ui'
import { getUserReferrals, getUserProfile } from '@/lib/api/user'
import { setUser, setApiUser, setReferralCode } from '../state/slices/auth'

const AVATARS = [
  { id: 1, url: '/avatar-1.jpg' },
  { id: 2, url: '/avatar-2.jpg' }
]

const MOCK_TRANSACTIONS: any[] = []

const DefaultAvatarIcon = () => (
  <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M1.53218 12.187C2.5664 12.187 3.08351 11.6632 3.08351 10.6157V6.0935C3.08351 5.09708 3.33887 4.34657 3.84959 3.84197C4.36032 3.33738 5.09449 3.08508 6.0521 3.08508H10.6869C11.7339 3.08508 12.2574 2.5677 12.2574 1.53296C12.2574 0.510985 11.7339 0 10.6869 0H6.0138C4.00919 0 2.50574 0.495017 1.50345 1.48505C0.501149 2.47508 0 3.95374 0 5.92104V10.6157C0 11.6632 0.510725 12.187 1.53218 12.187ZM35.9487 12.187C36.9829 12.187 37.5 11.6632 37.5 10.6157V5.92104C37.5 3.95374 36.9989 2.47508 35.9966 1.48505C34.9943 0.495017 33.4908 0 31.4862 0H26.7939C25.7597 0 25.2426 0.510985 25.2426 1.53296C25.2426 2.5677 25.7597 3.08508 26.7939 3.08508H31.4288C32.3735 3.08508 33.1077 3.33738 33.6312 3.84197C34.1547 4.34657 34.4164 5.09708 34.4164 6.0935V10.6157C34.4164 11.6632 34.9272 12.187 35.9487 12.187ZM6.0138 37.5H10.6869C11.7339 37.5 12.2574 36.989 12.2574 35.967C12.2574 34.9322 11.7339 34.4149 10.6869 34.4149H6.0521C5.09449 34.4149 4.36032 34.1626 3.84959 33.658C3.33887 33.1534 3.08351 32.4028 3.08351 31.4064V26.8842C3.08351 25.8367 2.5664 25.3129 1.53218 25.3129C0.510725 25.3129 0 25.8367 0 26.8842V31.5597C0 33.5398 0.501149 35.0248 1.50345 36.0148C2.50574 37.0049 4.00919 37.5 6.0138 37.5ZM26.7939 37.5H31.4862C33.4908 37.5 34.9943 37.0049 35.9966 36.0148C36.9989 35.0248 37.5 33.5398 37.5 31.5597V26.8842C37.5 25.8367 36.9829 25.3129 35.9487 25.3129C34.9272 25.3129 34.4164 25.8367 34.4164 26.8842V31.4064C34.4164 32.4028 34.1547 33.1534 33.6312 33.658C33.1077 34.1626 32.3735 34.4149 31.4288 34.4149H26.7939C25.7597 34.4149 25.2426 34.9322 25.2426 35.967C25.2426 36.989 25.7597 37.5 26.7939 37.5ZM10.2081 27.4207H27.3111C28.307 27.4207 29.0634 27.1716 29.5805 26.6735C30.0976 26.1752 30.3562 25.4279 30.3562 24.4315V14.2948C30.3562 13.2856 30.0976 12.5319 29.5805 12.0337C29.0634 11.5355 28.307 11.2864 27.3111 11.2864H24.8211C24.4509 11.2864 24.1764 11.2417 23.9976 11.1522C23.8189 11.0628 23.621 10.8968 23.404 10.654L22.6187 9.77259C22.3762 9.5171 22.1112 9.3191 21.8239 9.17858C21.5366 9.03805 21.1504 8.96778 20.6652 8.96778H16.7965C16.2985 8.96778 15.9059 9.03805 15.6186 9.17858C15.3313 9.3191 15.0664 9.5171 14.8238 9.77259L14.0386 10.654C13.8215 10.884 13.6268 11.0469 13.4544 11.1427C13.2821 11.2385 13.0043 11.2864 12.6213 11.2864H10.2081C9.19943 11.2864 8.43973 11.5355 7.92901 12.0337C7.41828 12.5319 7.16291 13.2856 7.16291 14.2948V24.4315C7.16291 25.4279 7.41828 26.1752 7.92901 26.6735C8.43973 27.1716 9.19943 27.4207 10.2081 27.4207ZM18.7883 25.0064C17.7158 25.0064 16.7454 24.7509 15.8772 24.2398C15.0089 23.7288 14.3163 23.039 13.7991 22.1705C13.282 21.3017 13.0235 20.3308 13.0235 19.2577C13.0235 18.1975 13.282 17.233 13.7991 16.3643C14.3163 15.4956 15.0089 14.8058 15.8772 14.2948C16.7454 13.7838 17.7158 13.5283 18.7883 13.5283C19.848 13.5283 20.8088 13.7838 21.6707 14.2948C22.5326 14.8058 23.2221 15.4956 23.7392 16.3643C24.2563 17.233 24.5148 18.1975 24.5148 19.2577C24.5148 20.3436 24.2563 21.3209 23.7392 22.1895C23.2221 23.0582 22.5326 23.7448 21.6707 24.2494C20.8088 24.7541 19.848 25.0064 18.7883 25.0064ZM18.7691 23.3584C19.5097 23.3584 20.1896 23.1763 20.809 22.8123C21.4282 22.4482 21.9229 21.9532 22.2932 21.3273C22.6634 20.7014 22.8486 20.0115 22.8486 19.2577C22.8486 18.504 22.6634 17.8174 22.2932 17.1978C21.9229 16.5783 21.4282 16.0865 20.809 15.7224C20.1896 15.3583 19.5097 15.1763 18.7691 15.1763C18.0158 15.1763 17.3263 15.3583 16.7007 15.7224C16.0751 16.0865 15.5803 16.5783 15.2164 17.1978C14.8525 17.8174 14.6706 18.504 14.6706 19.2577C14.6706 20.0115 14.8525 20.7014 15.2164 21.3273C15.5803 21.9532 16.0751 22.4482 16.7007 22.8123C17.3263 23.1763 18.0158 23.3584 18.7691 23.3584ZM26.4109 16.4984C26.0661 16.4984 25.766 16.3739 25.5107 16.1248C25.2553 15.8757 25.1277 15.5659 25.1277 15.1954C25.1277 14.8377 25.2553 14.5343 25.5107 14.2852C25.766 14.0361 26.0661 13.9116 26.4109 13.9116C26.7683 13.9116 27.0747 14.0361 27.3301 14.2852C27.5856 14.5343 27.7133 14.8377 27.7133 15.1954C27.7133 15.5659 27.5856 15.8757 27.3301 16.1248C27.0747 16.3739 26.7683 16.4984 26.4109 16.4984Z" fill="white" fillOpacity="0.8" />
  </svg>
)

const CrownIconSVG = ({ isSelected }: { isSelected: boolean }) => (
  <svg width="22" height="17" viewBox="0 0 22 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M10.4205 0.794487C10.3497 0.823499 10.275 0.863647 10.2543 0.883721C10.2337 0.903825 10.2002 0.920247 10.1799 0.920247C10.1408 0.920247 9.98521 1.08592 9.98521 1.12755C9.98521 1.14106 9.93708 1.23508 9.87825 1.33646C9.81942 1.43787 9.76322 1.55217 9.75334 1.5905C9.74347 1.62884 9.71616 1.67576 9.69266 1.69473C9.66916 1.71374 9.64992 1.74913 9.64992 1.77337C9.64992 1.79763 9.60981 1.89954 9.5608 1.99988C9.51176 2.10022 9.46226 2.21906 9.4508 2.26396C9.43934 2.30886 9.42092 2.34563 9.40986 2.34563C9.39883 2.34563 9.3567 2.42916 9.31623 2.53122C9.27578 2.63332 9.22457 2.7379 9.20247 2.76371C9.18034 2.78948 9.16224 2.82595 9.16224 2.84472C9.16224 2.881 9.06946 3.08858 8.90008 3.43126C8.84311 3.54657 8.79648 3.65184 8.79648 3.6652C8.79648 3.70327 8.6071 4.06838 8.57836 4.08566C8.56422 4.09418 8.55263 4.12578 8.55263 4.15586C8.55263 4.18594 8.49777 4.31505 8.43071 4.4428C8.36366 4.57055 8.30879 4.68574 8.30879 4.69878C8.30879 4.72147 8.25951 4.82748 8.00152 5.35971C7.93818 5.49037 7.86363 5.65072 7.8358 5.71605C7.74466 5.93019 7.59482 6.24454 7.46296 6.49817C7.39173 6.63522 7.33342 6.76404 7.33342 6.78447C7.33342 6.8049 7.30599 6.85559 7.27246 6.89713C7.23893 6.93864 7.2115 6.99245 7.2115 7.01668C7.2115 7.1238 7.03389 7.42194 6.87814 7.5762C6.77118 7.68216 6.40835 7.87343 6.26625 7.89873C6.08638 7.93077 5.83267 7.88373 5.60568 7.77623C5.49141 7.72213 5.39107 7.67064 5.38269 7.66185C5.36257 7.64079 5.15366 7.4927 4.83404 7.27301C4.69155 7.17508 4.54997 7.07462 4.51939 7.04982C4.48885 7.025 4.43058 6.99236 4.38985 6.97728C4.34916 6.96222 4.31588 6.9371 4.31588 6.92145C4.31588 6.90583 4.28503 6.88365 4.2473 6.87216C4.20956 6.86069 4.13562 6.81636 4.08295 6.77366C3.98078 6.69078 3.90379 6.634 3.79656 6.56237C3.75989 6.53788 3.68152 6.48107 3.62242 6.43617C3.56335 6.39124 3.50227 6.35451 3.48669 6.35451C3.47112 6.35451 3.40784 6.30785 3.34609 6.25084C3.28434 6.19379 3.21908 6.14702 3.20103 6.14691C3.18302 6.14676 3.13605 6.11323 3.09667 6.0724C3.05729 6.03157 3.01532 5.99816 3.0034 5.99816C2.98377 5.99816 2.73532 5.83837 2.51861 5.68636C2.47204 5.65369 2.34646 5.56785 2.2395 5.49557C2.13258 5.42332 1.98883 5.31974 1.92004 5.26543C1.85124 5.21111 1.78419 5.16669 1.77099 5.16669C1.75782 5.16669 1.7314 5.14587 1.71232 5.12045C1.66498 5.05738 1.30653 5.03086 1.15593 5.0793C0.977406 5.1367 0.788855 5.3424 0.763435 5.50753C0.725243 5.75576 0.748164 5.88324 1.02276 6.94841C1.10908 7.28323 1.21402 7.69748 1.256 7.86897C1.29794 8.04046 1.35734 8.27431 1.38798 8.38864C1.41864 8.50297 1.46668 8.71678 1.49475 8.86377C1.52282 9.01076 1.57211 9.22457 1.60423 9.33889C1.63639 9.45322 1.69089 9.68039 1.72536 9.84372C1.75986 10.007 1.80071 10.1874 1.81616 10.2446C1.83162 10.3018 1.85295 10.402 1.86359 10.4673C1.87423 10.5326 1.89565 10.6012 1.91126 10.6195C1.92687 10.6379 1.95591 10.7649 1.97585 10.9016C1.99578 11.0384 2.02312 11.1579 2.03659 11.1672C2.0501 11.1764 2.08168 11.29 2.10679 11.4196C2.13191 11.5491 2.16787 11.6952 2.18671 11.7442C2.20555 11.7932 2.23179 11.9001 2.24505 11.9818C2.27425 12.1616 2.32335 12.3747 2.38309 12.5806C2.40757 12.665 2.46743 12.9056 2.51608 13.1151C2.56476 13.3248 2.627 13.5898 2.65437 13.7041C2.68177 13.8184 2.72484 14.0122 2.75014 14.1347C2.84393 14.5894 2.8613 14.6554 2.89861 14.6989C2.91961 14.7234 2.94475 14.8103 2.95448 14.8919C3.00099 15.2826 3.11151 15.499 3.331 15.6292C3.56442 15.7676 3.83572 15.7825 4.27016 15.6807C4.64616 15.5926 4.9687 15.5245 5.18457 15.4875C5.46355 15.4397 5.83937 15.3686 6.08373 15.3174C6.17594 15.2981 6.30624 15.2796 6.3733 15.2764C6.44035 15.2731 6.53636 15.2614 6.58666 15.2502C6.85135 15.1916 6.94258 15.1771 7.16578 15.1587C7.2999 15.1476 7.46543 15.127 7.53365 15.1128C7.71693 15.0748 8.89746 14.9733 9.40608 14.9518C10.476 14.9065 12.9354 14.9631 13.056 15.0358C13.0702 15.0443 13.2005 15.0541 13.3455 15.0575C13.4906 15.0609 13.682 15.075 13.7709 15.0889C13.9682 15.1198 14.0902 15.1345 14.4734 15.1737C14.6368 15.1903 14.8288 15.224 14.9001 15.2486C14.9713 15.2731 15.1257 15.3008 15.2431 15.3101C15.3604 15.3195 15.5387 15.3401 15.6393 15.3559C15.7399 15.3718 15.9045 15.397 16.0051 15.412C16.1647 15.4358 16.5702 15.516 16.9042 15.5899C16.9629 15.6029 17.0795 15.6274 17.1633 15.6443C17.2471 15.6613 17.3569 15.695 17.4071 15.7192C17.4817 15.7552 17.5492 15.7582 17.7729 15.7356C17.9238 15.7204 18.0518 15.6947 18.0574 15.6786C18.063 15.6624 18.0863 15.6492 18.1093 15.6492C18.1671 15.6492 18.3527 15.4574 18.4213 15.3268C18.4526 15.2673 18.5025 15.1117 18.5322 14.981C18.5619 14.8504 18.6055 14.6655 18.6291 14.5703C18.6528 14.4751 18.6721 14.3713 18.6721 14.3398C18.6721 14.3082 18.6841 14.2592 18.6988 14.2308C18.7459 14.14 18.794 13.9694 18.794 13.8932C18.794 13.8124 18.9578 13.1495 18.9905 13.0979C19.0128 13.0627 19.0196 13.0315 19.0518 12.816C19.0637 12.7358 19.0885 12.6356 19.1068 12.5932C19.1397 12.5174 19.1715 12.381 19.261 11.9315C19.286 11.8058 19.3147 11.69 19.3248 11.6742C19.3348 11.6583 19.3623 11.5541 19.3858 11.4424C19.4292 11.2367 19.6134 10.5019 19.6898 10.2298C19.7128 10.1481 19.7457 10.0145 19.7629 9.9328C19.7802 9.85114 19.8244 9.66406 19.8612 9.51707C19.9401 9.20191 19.9686 9.0744 20.0134 8.83407C20.0317 8.73608 20.0597 8.65145 20.0756 8.64601C20.0916 8.64055 20.1046 8.59378 20.1045 8.54208C20.1044 8.49035 20.1242 8.3879 20.1485 8.3144C20.1727 8.24091 20.2365 7.98701 20.2902 7.75019C20.344 7.51337 20.4076 7.23943 20.4316 7.14143C20.4557 7.04344 20.4926 6.88279 20.5136 6.78441C20.5346 6.68603 20.5734 6.53235 20.5999 6.44291C20.7546 5.91867 20.7887 5.56431 20.7035 5.36562C20.6222 5.17598 20.3717 5.04633 20.0826 5.04417C19.9295 5.04304 19.871 5.05548 19.8199 5.10008C19.7837 5.13165 19.6718 5.20657 19.5712 5.26659C19.4707 5.3266 19.3061 5.43549 19.2055 5.5086C19.1049 5.58171 18.9936 5.65393 18.9582 5.66911C18.9227 5.68425 18.8855 5.71772 18.8753 5.74346C18.8652 5.76924 18.8421 5.79029 18.8241 5.79029C18.7903 5.79029 18.3947 6.04555 18.3674 6.08502C18.359 6.09725 18.2869 6.14408 18.2073 6.18916C18.1276 6.23421 18.0625 6.28089 18.0625 6.29295C18.0625 6.31623 17.7788 6.50298 17.7434 6.50298C17.7319 6.50298 17.6813 6.54307 17.6311 6.59207C17.5808 6.64107 17.5208 6.68116 17.4978 6.68116C17.4747 6.68116 17.4449 6.69876 17.4315 6.72032C17.4017 6.76819 17.0779 6.97811 17.0338 6.97811C17.0164 6.97811 16.9286 7.04469 16.8389 7.12605C16.7491 7.20745 16.6585 7.27426 16.6375 7.27453C16.6166 7.27483 16.5994 7.28843 16.5994 7.30476C16.5994 7.32109 16.5802 7.33445 16.5566 7.33445C16.5179 7.33445 16.4409 7.389 16.1575 7.6171C16.0408 7.71096 15.8597 7.80254 15.685 7.85602C15.5272 7.90434 15.1364 7.91357 15.1364 7.86897C15.1364 7.85264 15.1261 7.84147 15.1135 7.84415C15.0588 7.85579 14.8994 7.79589 14.8011 7.72679C14.5607 7.55776 14.2829 7.17692 14.2829 7.01633C14.2829 6.9923 14.2555 6.93864 14.222 6.89713C14.1884 6.85559 14.161 6.7978 14.161 6.7687C14.161 6.7396 14.1503 6.71136 14.1372 6.70589C14.1145 6.69645 13.916 6.28273 13.9045 6.22088C13.9015 6.20454 13.8825 6.16199 13.8624 6.12633C13.8422 6.09063 13.8255 6.04386 13.8252 6.02239C13.8249 6.00089 13.7833 5.92392 13.7328 5.85132C13.6823 5.77871 13.6333 5.68517 13.6239 5.64345C13.6145 5.60173 13.569 5.49408 13.5227 5.40425C13.4764 5.31442 13.4069 5.16075 13.3682 5.06276C13.3295 4.96476 13.281 4.86454 13.2606 4.84004C13.2401 4.81554 13.2131 4.76298 13.2007 4.72322C13.1882 4.68346 13.1248 4.54718 13.0599 4.42039C12.9949 4.29359 12.9418 4.18104 12.9418 4.17026C12.9418 4.15327 12.8036 3.87007 12.7325 3.74131C12.6636 3.61659 12.5109 3.29196 12.4541 3.14978C12.3888 2.98592 12.3511 2.9039 12.1117 2.40502C12.0373 2.24986 11.9451 2.04273 11.9069 1.94474C11.8686 1.84674 11.8252 1.74652 11.8104 1.72202C11.7587 1.63662 11.6311 1.35808 11.6311 1.33061C11.6311 1.31537 11.5676 1.22017 11.49 1.119C11.3036 0.876238 11.0907 0.767642 10.7712 0.752349C10.6075 0.744539 10.5153 0.755615 10.4205 0.794487Z"
      stroke="white"
      strokeOpacity={isSelected ? '1' : '0.8'}
      strokeWidth="1.5"
    />
  </svg>
)

const ReferralsIconSVG = ({ isSelected }: { isSelected: boolean }) => {
  if (isSelected) {
    return (
      <svg width="24" height="12" viewBox="0 0 24 12" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M8.00213 12H15.9979C16.5029 12 16.8562 11.9255 17.0578 11.7764C17.2594 11.6274 17.3602 11.406 17.3602 11.1123C17.3602 10.6852 17.2361 10.2336 16.9878 9.75748C16.7395 9.28141 16.383 8.83536 15.9183 8.41933C15.4536 8.00331 14.8913 7.66515 14.2313 7.40486C13.5714 7.14457 12.8276 7.01442 12 7.01442C11.1767 7.01442 10.435 7.14457 9.77506 7.40486C9.11513 7.66515 8.55173 8.00331 8.08485 8.41933C7.61802 8.83536 7.26152 9.28141 7.01537 9.75748C6.76922 10.2336 6.64615 10.6852 6.64615 11.1123C6.64615 11.406 6.74695 11.6274 6.94856 11.7764C7.15012 11.9255 7.50131 12 8.00213 12ZM12.0064 5.81979C12.4605 5.81979 12.8807 5.68964 13.2669 5.42935C13.653 5.16906 13.9639 4.81645 14.1995 4.37151C14.435 3.92658 14.5528 3.42602 14.5528 2.86985C14.5528 2.32257 14.435 1.83203 14.1995 1.39821C13.9639 0.964403 13.653 0.622915 13.2669 0.373748C12.8807 0.124583 12.4605 0 12.0064 0C11.5522 0 11.1321 0.126807 10.7459 0.380421C10.3597 0.634037 10.0488 0.978865 9.81326 1.4149C9.57771 1.85094 9.45994 2.34037 9.45994 2.8832C9.45994 3.43492 9.57771 3.93214 9.81326 4.37485C10.0488 4.81756 10.3597 5.16906 10.7459 5.42935C11.1321 5.68964 11.5522 5.81979 12.0064 5.81979ZM1.12042 12H5.95226C5.78674 11.7464 5.70822 11.4416 5.71671 11.0856C5.7252 10.7297 5.80371 10.3559 5.95226 9.96435C6.1008 9.57284 6.30556 9.19354 6.56655 8.82645C6.82757 8.45936 7.12995 8.13567 7.47371 7.85537C7.11722 7.6062 6.70874 7.40042 6.24828 7.23804C5.7878 7.07561 5.26048 6.99439 4.66631 6.99439C3.94907 6.99439 3.30292 7.11787 2.72785 7.36481C2.15279 7.61175 1.6626 7.93656 1.25729 8.33924C0.851989 8.74191 0.541114 9.18128 0.324669 9.65736C0.108223 10.1334 0 10.6029 0 11.0656C0 11.3637 0.0859417 11.594 0.257825 11.7564C0.429709 11.9188 0.717242 12 1.12042 12ZM4.66631 5.97329C5.06525 5.97329 5.43236 5.85983 5.76764 5.63291C6.10292 5.406 6.37242 5.09788 6.57613 4.70855C6.77983 4.31923 6.88167 3.8843 6.88167 3.40377C6.88167 2.92324 6.77983 2.49499 6.57613 2.11901C6.37242 1.74304 6.10186 1.44716 5.76445 1.23136C5.42706 1.01557 5.06101 0.907672 4.66631 0.907672C4.27586 0.907672 3.91194 1.01779 3.57454 1.23804C3.23714 1.45828 2.96446 1.75751 2.7565 2.1357C2.54854 2.5139 2.44669 2.94104 2.45093 3.41712C2.45093 3.89321 2.55279 4.3248 2.7565 4.71189C2.96022 5.09899 3.23077 5.406 3.56817 5.63291C3.90557 5.85983 4.27162 5.97329 4.66631 5.97329ZM22.8796 12C23.2828 12 23.5703 11.9188 23.7422 11.7564C23.9141 11.594 24 11.3637 24 11.0656C24 10.6029 23.8928 10.1334 23.6785 9.65736C23.4642 9.18128 23.1533 8.74191 22.7459 8.33924C22.3385 7.93656 21.8472 7.61175 21.2721 7.36481C20.6971 7.11787 20.0509 6.99439 19.3337 6.99439C18.7395 6.99439 18.2122 7.07561 17.7517 7.23804C17.2913 7.40042 16.8828 7.6062 16.5263 7.85537C16.87 8.13567 17.1724 8.45936 17.4334 8.82645C17.6945 9.19354 17.8992 9.57284 18.0477 9.96435C18.1963 10.3559 18.2748 10.7297 18.2833 11.0856C18.2918 11.4416 18.2133 11.7464 18.0477 12H22.8796ZM19.3337 5.97329C19.7284 5.97329 20.0944 5.85983 20.4319 5.63291C20.7692 5.406 21.0398 5.09899 21.2435 4.71189C21.4472 4.3248 21.549 3.89321 21.549 3.41712C21.549 2.94104 21.4461 2.5139 21.2403 2.1357C21.0345 1.75751 20.7629 1.45828 20.4255 1.23804C20.088 1.01779 19.7241 0.907672 19.3337 0.907672C18.939 0.907672 18.5729 1.01557 18.2355 1.23136C17.8982 1.44716 17.6276 1.74304 17.4239 2.11901C17.2202 2.49499 17.1183 2.92324 17.1183 3.40377C17.1183 3.8843 17.2202 4.31923 17.4239 4.70855C17.6276 5.09788 17.8971 5.406 18.2324 5.63291C18.5676 5.85983 18.9347 5.97329 19.3337 5.97329Z" fill="white" fillOpacity="0.8" />
      </svg>
    )
  }
  return (
    <svg width="24" height="12" viewBox="0 0 24 12" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8.05229 12H15.9414C16.9665 12 17.4791 11.657 17.4791 10.9711C17.4791 10.5509 17.3535 10.1029 17.1025 9.62702C16.8514 9.15113 16.4885 8.70204 16.0136 8.27975C15.5387 7.85746 14.9634 7.51341 14.2876 7.24759C13.6119 6.98176 12.8494 6.84885 12 6.84885C11.1464 6.84885 10.3818 6.98176 9.70603 7.24759C9.03032 7.51341 8.45501 7.85746 7.98012 8.27975C7.50522 8.70204 7.14226 9.15113 6.89123 9.62702C6.64016 10.1029 6.51462 10.5509 6.51462 10.9711C6.51462 11.657 7.02718 12 8.05229 12ZM7.7573 11.0289C7.67363 11.0289 7.61401 11.0161 7.57845 10.9904C7.54289 10.9646 7.5251 10.9175 7.5251 10.8489C7.5251 10.5874 7.62238 10.284 7.81694 9.9389C8.0115 9.59379 8.29917 9.26047 8.67993 8.93893C9.06065 8.61735 9.52927 8.35045 10.0858 8.13824C10.6423 7.92602 11.2803 7.81991 12 7.81991C12.7197 7.81991 13.3567 7.92602 13.9111 8.13824C14.4655 8.35045 14.933 8.61735 15.3138 8.93893C15.6945 9.26047 15.9822 9.59379 16.1768 9.9389C16.3713 10.284 16.4686 10.5874 16.4686 10.8489C16.4686 10.9175 16.4508 10.9646 16.4153 10.9904C16.3797 11.0161 16.3222 11.0289 16.2426 11.0289H7.7573ZM12 5.96142C12.4979 5.96142 12.9519 5.82422 13.3619 5.54984C13.7719 5.27546 14.0993 4.90997 14.3441 4.45338C14.5889 3.99678 14.7113 3.49196 14.7113 2.93891C14.7113 2.39014 14.5899 1.89389 14.3472 1.45016C14.1046 1.00643 13.7782 0.653804 13.3682 0.392283C12.9582 0.130761 12.5021 0 12 0C11.5021 0 11.0481 0.132905 10.638 0.398714C10.228 0.664521 9.90061 1.02036 9.65584 1.46624C9.41106 1.91211 9.28867 2.40729 9.28867 2.95177C9.28867 3.50054 9.41106 4.00322 9.65584 4.45981C9.90061 4.9164 10.228 5.28082 10.638 5.55305C11.0481 5.82529 11.5021 5.96142 12 5.96142ZM12 4.99035C11.6946 4.99035 11.4132 4.89925 11.1558 4.71704C10.8985 4.53483 10.6914 4.28939 10.5345 3.98071C10.3776 3.67203 10.2992 3.32905 10.2992 2.95177C10.2992 2.57878 10.3766 2.2433 10.5314 1.94534C10.6862 1.64738 10.8922 1.41051 11.1495 1.23473C11.4069 1.05895 11.6904 0.971064 12 0.971064C12.3138 0.971064 12.5994 1.05681 12.8567 1.2283C13.114 1.39979 13.319 1.63452 13.4717 1.93248C13.6245 2.23044 13.7008 2.56592 13.7008 2.93891C13.7008 3.31618 13.6234 3.66024 13.4686 3.97106C13.3138 4.28189 13.1077 4.52948 12.8504 4.71383C12.5931 4.89818 12.3096 4.99035 12 4.99035ZM1.27406 12H6.20083C6.0502 11.9143 5.92677 11.7835 5.83054 11.6077C5.7343 11.4319 5.69665 11.2454 5.71756 11.0482H1.12343C1.05649 11.0482 1.00837 11.0343 0.97908 11.0064C0.949791 10.9785 0.935146 10.9346 0.935146 10.8746C0.935146 10.4759 1.03661 10.0922 1.23954 9.72349C1.44246 9.35477 1.72175 9.02465 2.0774 8.73314C2.43305 8.44159 2.841 8.21116 3.30125 8.04183C3.7615 7.87246 4.24895 7.78777 4.76359 7.78777C5.02719 7.78777 5.28137 7.80922 5.52614 7.85211C5.77091 7.89496 6.00522 7.95712 6.22907 8.0386C6.4529 8.12004 6.66735 8.22292 6.8724 8.34725C6.96863 8.21866 7.07532 8.09756 7.19245 7.98394C7.30959 7.87033 7.43931 7.76422 7.5816 7.66561C7.30961 7.48123 7.02195 7.32795 6.71861 7.20577C6.41526 7.08359 6.10041 6.99142 5.77405 6.92926C5.44769 6.86709 5.11087 6.83601 4.76359 6.83601C4.10669 6.83601 3.49058 6.94748 2.91527 7.17041C2.33995 7.39334 1.83368 7.69773 1.39644 8.08358C0.959202 8.46943 0.617152 8.90673 0.370292 9.39548C0.123431 9.88424 0 10.3966 0 10.9325C0 11.2883 0.106694 11.5552 0.320083 11.7331C0.533472 11.911 0.851463 12 1.27406 12ZM4.76987 6.10289C5.20083 6.10289 5.59413 5.98392 5.94978 5.74598C6.30543 5.50804 6.58995 5.18864 6.80331 4.78778C7.01673 4.38692 7.12343 3.94212 7.12343 3.45338C7.12343 2.97749 7.01778 2.54448 6.80646 2.15434C6.59519 1.7642 6.31173 1.45338 5.95606 1.22187C5.60041 0.990354 5.20501 0.874597 4.76987 0.874597C4.33891 0.874597 3.94456 0.991425 3.58681 1.22508C3.22907 1.45873 2.94351 1.77277 2.73012 2.1672C2.51673 2.56163 2.41213 2.99464 2.41632 3.46624C2.41632 3.9507 2.52301 4.39228 2.7364 4.791C2.94979 5.18971 3.23431 5.50804 3.58995 5.74598C3.9456 5.98392 4.33891 6.10289 4.76987 6.10289ZM4.76987 5.1447C4.51464 5.1447 4.27928 5.06967 4.0638 4.91962C3.84832 4.76956 3.67573 4.56699 3.54602 4.3119C3.41631 4.05681 3.35146 3.77492 3.35146 3.46624C3.35146 3.16613 3.41527 2.89175 3.54289 2.64309C3.6705 2.39443 3.84205 2.19721 4.05753 2.05145C4.27301 1.90568 4.51046 1.8328 4.76987 1.8328C5.03347 1.8328 5.27301 1.90461 5.48849 2.04823C5.70397 2.19186 5.87552 2.38585 6.00313 2.63023C6.13074 2.8746 6.19455 3.14898 6.19455 3.45338C6.19455 3.76635 6.1297 4.05145 5.99999 4.30869C5.87028 4.56592 5.69664 4.76956 5.47907 4.91962C5.2615 5.06967 5.0251 5.1447 4.76987 5.1447ZM22.7197 12C23.1464 12 23.4665 11.911 23.6799 11.7331C23.8933 11.5552 24 11.2883 24 10.9325C24 10.3966 23.8766 9.88424 23.6297 9.39548C23.3828 8.90673 23.0408 8.46943 22.6035 8.08358C22.1663 7.69773 21.66 7.39334 21.0847 7.17041C20.5094 6.94748 19.8933 6.83601 19.2363 6.83601C18.8891 6.83601 18.5512 6.86709 18.2228 6.92926C17.8943 6.99142 17.5795 7.08359 17.2782 7.20577C16.977 7.32795 16.6903 7.48123 16.4184 7.66561C16.5606 7.76422 16.6893 7.87033 16.8044 7.98394C16.9194 8.09756 17.0272 8.21866 17.1276 8.34725C17.3326 8.22292 17.5471 8.12004 17.7709 8.0386C17.9947 7.95712 18.229 7.89496 18.4738 7.85211C18.7186 7.80922 18.9728 7.78777 19.2363 7.78777C19.7468 7.78777 20.2322 7.87246 20.6925 8.04183C21.1527 8.21116 21.5607 8.44159 21.9163 8.73314C22.2719 9.02465 22.5523 9.35477 22.7573 9.72349C22.9623 10.0922 23.0648 10.4759 23.0648 10.8746C23.0648 10.9346 23.0491 10.9785 23.0177 11.0064C22.9864 11.0343 22.9393 11.0482 22.8765 11.0482H18.2824C18.3033 11.2454 18.2646 11.4319 18.1663 11.6077C18.068 11.7835 17.9435 11.9143 17.7928 12H22.7197ZM19.2301 6.10289C19.6611 6.10289 20.0543 5.98392 20.41 5.74598C20.7657 5.50804 21.0502 5.18971 21.2635 4.791C21.477 4.39228 21.5837 3.9507 21.5837 3.46624C21.5837 2.99464 21.477 2.56163 21.2635 2.1672C21.0502 1.77277 20.7657 1.45873 20.41 1.22508C20.0543 0.991425 19.6611 0.874597 19.2301 0.874597C18.7949 0.874597 18.3995 0.990354 18.0439 1.22187C17.6883 1.45338 17.4048 1.7642 17.1935 2.15434C16.9822 2.54448 16.8766 2.97749 16.8766 3.45338C16.8766 3.94212 16.9833 4.38692 17.1966 4.78778C17.41 5.18864 17.6945 5.50804 18.0502 5.74598C18.4058 5.98392 18.7991 6.10289 19.2301 6.10289ZM19.2301 5.1447C18.9749 5.1447 18.7385 5.06967 18.5209 4.91962C18.3033 4.76956 18.1297 4.56592 18 4.30869C17.8703 4.05145 17.8054 3.76635 17.8054 3.45338C17.8054 3.14898 17.8692 2.8746 17.9968 2.63023C18.1245 2.38585 18.296 2.19186 18.5115 2.04823C18.7269 1.90461 18.9665 1.8328 19.2301 1.8328C19.4895 1.8328 19.7269 1.90568 19.9425 2.05145C20.1579 2.19721 20.3295 2.39443 20.4571 2.64309C20.5847 2.89175 20.6485 3.16613 20.6485 3.46624C20.6485 3.77492 20.5837 4.05681 20.454 4.3119C20.3242 4.56699 20.1516 4.76956 19.9362 4.91962C19.7207 5.06967 19.4853 5.1447 19.2301 5.1447Z" fill="white" fillOpacity="0.8" />
    </svg>
  )
}

const FavoritesIconSVG = ({ isSelected }: { isSelected: boolean }) => (
  <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg">
    {isSelected ? (
      <>
        <path d="M1.10089 18C1.35015 18 1.58556 17.9315 1.80712 17.7944C2.02868 17.6573 2.37487 17.4042 2.84569 17.0349L6.90651 13.8042C6.96882 13.7482 7.03114 13.7482 7.09345 13.8042L11.1543 17.0349C11.6251 17.3986 11.9695 17.6503 12.1877 17.7902C12.4058 17.9301 12.6429 18 12.8991 18C13.2453 18 13.5153 17.9105 13.7091 17.7315C13.903 17.5524 14 17.3007 14 16.9762V2.40838C14 1.60839 13.7542 1.00699 13.2626 0.604195C12.771 0.201398 12.037 0 11.0608 0H2.93916C1.9629 0 1.22898 0.201398 0.737386 0.604195C0.245795 1.00699 0 1.60839 0 2.40838V16.9762C0 17.3007 0.0969336 17.5524 0.290801 17.7315C0.484667 17.9105 0.754697 18 1.10089 18Z" fill="white" fillOpacity="1" />
        <path d="M1.95252 15.7342C1.87636 15.7902 1.80539 15.8112 1.73961 15.7972C1.67383 15.7832 1.64095 15.7343 1.64095 15.6503V2.42517C1.64095 2.06154 1.75692 1.78741 1.98887 1.60279C2.22082 1.41818 2.56528 1.32587 3.02225 1.32587H10.9881C11.4381 1.32587 11.7791 1.41818 12.011 1.60279C12.243 1.78741 12.359 2.06154 12.359 2.42517V15.6503C12.359 15.7343 12.3261 15.7832 12.2603 15.7972C12.1945 15.8112 12.1236 15.7902 12.0474 15.7342L7.55042 12.2098C7.38425 12.0811 7.20077 12.0168 6.99998 12.0168C6.79919 12.0168 6.61571 12.0811 6.44953 12.2098L1.95252 15.7342Z" fill="white" fillOpacity="1" />
      </>
    ) : (
      <path d="M1.10089 18C1.35015 18 1.58556 17.9315 1.80712 17.7944C2.02868 17.6573 2.37487 17.4042 2.84569 17.0349L6.90651 13.8042C6.96882 13.7482 7.03114 13.7482 7.09345 13.8042L11.1543 17.0349C11.6251 17.3986 11.9695 17.6503 12.1877 17.7902C12.4058 17.9301 12.6429 18 12.8991 18C13.2453 18 13.5153 17.9105 13.7091 17.7315C13.903 17.5524 14 17.3007 14 16.9762V2.40838C14 1.60839 13.7542 1.00699 13.2626 0.604195C12.771 0.201398 12.037 0 11.0608 0H2.93916C1.9629 0 1.22898 0.201398 0.737386 0.604195C0.245795 1.00699 0 1.60839 0 2.40838V16.9762C0 17.3007 0.0969336 17.5524 0.290801 17.7315C0.484667 17.9105 0.754697 18 1.10089 18ZM1.95252 15.7342C1.87636 15.7902 1.80539 15.8112 1.73961 15.7972C1.67383 15.7832 1.64095 15.7343 1.64095 15.6503V2.42517C1.64095 2.06154 1.75692 1.78741 1.98887 1.60279C2.22082 1.41818 2.56528 1.32587 3.02225 1.32587H10.9881C11.4381 1.32587 11.7791 1.41818 12.011 1.60279C12.243 1.78741 12.359 2.06154 12.359 2.42517V15.6503C12.359 15.7343 12.3261 15.7832 12.2603 15.7972C12.1945 15.8112 12.1236 15.7902 12.0474 15.7342L7.55042 12.2098C7.38425 12.0811 7.20077 12.0168 6.99998 12.0168C6.79919 12.0168 6.61571 12.0811 6.44953 12.2098L1.95252 15.7342Z" fill="white" fillOpacity="0.8" />
    )}
  </svg>
)

const SelectionLine = () => (
  <svg width="86" height="1" viewBox="0 0 86 1" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="86" height="1" rx="0.5" fill="url(#paint0_linear_1_780)" fillOpacity="0.8" />
    <defs>
      <linearGradient id="paint0_linear_1_780" x1="0" y1="0.5" x2="86" y2="0.5" gradientUnits="userSpaceOnUse">
        <stop stopColor="white" stopOpacity="0" />
        <stop offset="0.5" stopColor="white" />
        <stop offset="1" stopColor="white" stopOpacity="0.02" />
      </linearGradient>
    </defs>
  </svg>
)

const RedCrownIcon = ({ className }: { className?: string }) => (
  <svg width="11" height="8" viewBox="0 0 11 8" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
    <path fillRule="evenodd" clipRule="evenodd" d="M5.31925 0.0237262C5.28032 0.0391995 5.23922 0.0606119 5.22789 0.0713181C5.21654 0.0820401 5.19813 0.0907982 5.18696 0.0907982C5.16546 0.0907982 5.07986 0.179156 5.07986 0.20136C5.07986 0.208566 5.05339 0.258708 5.02103 0.312777C4.98868 0.366863 4.95777 0.427822 4.95233 0.448268C4.9469 0.468714 4.93188 0.493737 4.91896 0.503857C4.90603 0.513993 4.89545 0.532872 4.89545 0.545795C4.89545 0.558735 4.87339 0.613089 4.84643 0.666604C4.81946 0.720119 4.79224 0.783501 4.78593 0.807447C4.77963 0.831394 4.7695 0.851001 4.76342 0.851001C4.75735 0.851001 4.73418 0.895552 4.71192 0.949985C4.68967 1.00443 4.66151 1.06021 4.64936 1.07398C4.63718 1.08772 4.62723 1.10717 4.62723 1.11718C4.62723 1.13654 4.5762 1.24724 4.48304 1.43001C4.45171 1.4915 4.42606 1.54765 4.42606 1.55477C4.42606 1.57508 4.3219 1.7698 4.30609 1.77902C4.29831 1.78356 4.29194 1.80041 4.29194 1.81646C4.29194 1.8325 4.26177 1.90136 4.22489 1.9695C4.18801 2.03763 4.15783 2.09906 4.15783 2.10602C4.15783 2.11812 4.13072 2.17466 3.98883 2.45851C3.954 2.5282 3.91299 2.61372 3.89768 2.64856C3.84756 2.76277 3.76515 2.93042 3.69263 3.06569C3.65345 3.13878 3.62138 3.20749 3.62138 3.21838C3.62138 3.22928 3.60629 3.25631 3.58785 3.27847C3.56941 3.30061 3.55432 3.32931 3.55432 3.34223C3.55432 3.39936 3.45664 3.55837 3.37097 3.64064C3.31215 3.69715 3.11259 3.79916 3.03443 3.81265C2.93551 3.82974 2.79596 3.80466 2.67112 3.74732C2.60827 3.71847 2.55308 3.69101 2.54847 3.68632C2.53741 3.67509 2.42251 3.59611 2.24672 3.47894C2.16835 3.42671 2.09048 3.37313 2.07366 3.35991C2.05686 3.34667 2.02481 3.32926 2.00241 3.32121C1.98003 3.31319 1.96173 3.29979 1.96173 3.29144C1.96173 3.28311 1.94476 3.27128 1.92401 3.26515C1.90325 3.25904 1.86258 3.23539 1.83362 3.21262C1.77742 3.16841 1.73508 3.13813 1.6761 3.09993C1.65593 3.08687 1.61283 3.05657 1.58033 3.03262C1.54784 3.00866 1.51424 2.98907 1.50568 2.98907C1.49711 2.98907 1.46231 2.96419 1.42834 2.93378C1.39438 2.90336 1.35849 2.87841 1.34856 2.87835C1.33866 2.87827 1.31282 2.86039 1.29116 2.83861C1.2695 2.81684 1.24642 2.79902 1.23986 2.79902C1.22907 2.79902 1.09242 2.7138 0.973231 2.63272C0.947615 2.6153 0.878547 2.56952 0.819721 2.53097C0.760913 2.49244 0.681853 2.43719 0.644016 2.40823C0.60618 2.37926 0.569299 2.35557 0.56204 2.35557C0.554798 2.35557 0.540263 2.34447 0.529769 2.33091C0.503734 2.29727 0.306588 2.28313 0.223756 2.30896C0.125569 2.33957 0.0218656 2.44928 0.00788433 2.53735C-0.0131211 2.66974 -0.000514575 2.73773 0.150514 3.30582C0.19799 3.48439 0.255708 3.70532 0.278793 3.79678C0.30186 3.88825 0.334533 4.01297 0.351381 4.07394C0.368246 4.13492 0.394666 4.24895 0.410106 4.32734C0.425546 4.40574 0.452654 4.51977 0.470323 4.58074C0.488009 4.64172 0.517983 4.76288 0.536944 4.84998C0.555921 4.93709 0.578385 5.0333 0.586884 5.06379C0.595384 5.09428 0.607118 5.14773 0.612969 5.18257C0.61882 5.21741 0.630605 5.25395 0.639188 5.26375C0.647771 5.27356 0.663748 5.34126 0.674711 5.41421C0.685675 5.48716 0.700713 5.55087 0.708122 5.55581C0.715549 5.56076 0.732917 5.62133 0.74673 5.69043C0.760544 5.75953 0.780325 5.83745 0.790686 5.86359C0.801046 5.88972 0.81548 5.94673 0.822772 5.99029C0.838832 6.0862 0.865839 6.19983 0.898697 6.30967C0.912159 6.35468 0.945083 6.48296 0.971839 6.59474C0.998611 6.70654 1.03284 6.84789 1.0479 6.90886C1.06297 6.96984 1.08666 7.07318 1.10057 7.13851C1.15215 7.38101 1.16171 7.4162 1.18223 7.43942C1.19378 7.45249 1.20761 7.49881 1.21296 7.54237C1.23854 7.75074 1.29933 7.86613 1.42004 7.93556C1.54842 8.00938 1.69764 8.01732 1.93658 7.96304C2.14338 7.91607 2.32078 7.87972 2.43951 7.86C2.59295 7.83451 2.79965 7.79659 2.93405 7.76927C2.98476 7.75896 3.05643 7.74912 3.09331 7.7474C3.13019 7.74567 3.183 7.7394 3.21066 7.73346C3.35624 7.70217 3.40641 7.69447 3.52918 7.68465C3.60294 7.67874 3.69398 7.66774 3.7315 7.66018C3.8323 7.63991 4.4816 7.58574 4.76134 7.57428C5.34979 7.55016 6.70246 7.58034 6.7688 7.61908C6.77659 7.62363 6.84826 7.62884 6.92804 7.63066C7.00782 7.63247 7.11308 7.64002 7.16196 7.64743C7.27053 7.6639 7.33762 7.67174 7.54834 7.69262C7.63822 7.70152 7.74383 7.71949 7.78304 7.73257C7.82224 7.74564 7.90713 7.76042 7.97167 7.76539C8.03621 7.77038 8.13428 7.78137 8.18961 7.78983C8.24493 7.79828 8.33545 7.81175 8.39078 7.81974C8.47855 7.83243 8.7016 7.87521 8.88532 7.91461C8.91759 7.92153 8.98171 7.9346 9.02781 7.94364C9.07391 7.9527 9.13426 7.97068 9.16193 7.9836C9.20293 8.00278 9.24008 8.00438 9.3631 7.99234C9.44608 7.98422 9.51649 7.97052 9.51956 7.9619C9.52264 7.95327 9.53548 7.94622 9.54809 7.94622C9.57987 7.94622 9.682 7.84393 9.71974 7.77427C9.73694 7.74254 9.76438 7.65956 9.78071 7.58988C9.79705 7.52019 9.82104 7.42162 9.83402 7.37083C9.84701 7.32004 9.85764 7.26472 9.85764 7.24788C9.85764 7.23105 9.86426 7.20488 9.87234 7.18976C9.89824 7.14133 9.92469 7.05037 9.92469 7.00972C9.92469 6.96659 10.0148 6.61305 10.0328 6.58552C10.045 6.56679 10.0488 6.55014 10.0665 6.43518C10.073 6.39243 10.0867 6.33898 10.0968 6.3164C10.1148 6.27595 10.1323 6.20322 10.1815 5.96344C10.1953 5.8964 10.2111 5.83467 10.2166 5.82622C10.2221 5.81778 10.2372 5.76216 10.2502 5.70261C10.274 5.59292 10.3754 5.20099 10.4174 5.05587C10.43 5.01232 10.4481 4.94105 10.4576 4.89749C10.4671 4.85394 10.4914 4.75416 10.5117 4.67577C10.5551 4.50769 10.5707 4.43968 10.5954 4.31151C10.6054 4.25924 10.6208 4.2141 10.6296 4.21121C10.6384 4.20829 10.6455 4.18335 10.6455 4.15577C10.6454 4.12819 10.6563 4.07355 10.6696 4.03435C10.683 3.99515 10.7181 3.85974 10.7476 3.73343C10.7772 3.60713 10.8122 3.46103 10.8254 3.40876C10.8386 3.3565 10.8589 3.27082 10.8705 3.21835C10.882 3.16588 10.9034 3.08392 10.9179 3.03622C11.003 2.75662 11.0218 2.56763 10.9749 2.46166C10.9302 2.36053 10.7925 2.29138 10.6334 2.29022C10.5492 2.28962 10.5171 2.29626 10.4889 2.32004C10.469 2.33688 10.4075 2.37684 10.3522 2.40885C10.2969 2.44085 10.2063 2.49893 10.151 2.53792C10.0957 2.57691 10.0345 2.61543 10.015 2.62352C9.99551 2.6316 9.975 2.64945 9.96942 2.66318C9.96384 2.67693 9.95116 2.68816 9.94124 2.68816C9.92263 2.68816 9.70508 2.8243 9.69006 2.84534C9.68542 2.85187 9.64577 2.87685 9.60198 2.90089C9.5582 2.92491 9.52235 2.94981 9.52235 2.95624C9.52235 2.96866 9.36635 3.06826 9.34688 3.06826C9.34055 3.06826 9.31274 3.08964 9.28508 3.11577C9.25741 3.1419 9.22442 3.16328 9.21177 3.16328C9.19909 3.16328 9.18271 3.17267 9.17534 3.18417C9.15894 3.2097 8.98084 3.32166 8.9566 3.32166C8.94701 3.32166 8.89875 3.35717 8.84938 3.40056C8.79999 3.44397 8.75016 3.47961 8.73863 3.47975C8.72711 3.47991 8.71768 3.48716 8.71768 3.49587C8.71768 3.50458 8.70708 3.51171 8.69412 3.51171C8.67285 3.51171 8.63047 3.5408 8.4746 3.66245C8.41044 3.71251 8.31084 3.76136 8.21475 3.78988C8.12795 3.81565 7.913 3.82057 7.913 3.79678C7.913 3.78807 7.90735 3.78212 7.90042 3.78354C7.87035 3.78975 7.78266 3.75781 7.72859 3.72095C7.59637 3.63081 7.4436 3.42769 7.4436 3.34204C7.4436 3.32923 7.42851 3.30061 7.41007 3.27847C7.39163 3.25631 7.37655 3.22549 7.37655 3.20997C7.37655 3.19445 7.37066 3.17939 7.36345 3.17648C7.35096 3.17144 7.2418 2.95079 7.23548 2.9178C7.2338 2.90909 7.22337 2.8864 7.21229 2.86737C7.20121 2.84834 7.19201 2.82339 7.19184 2.81194C7.19167 2.80048 7.1688 2.75943 7.14104 2.7207C7.11326 2.68198 7.08633 2.63209 7.08114 2.60984C7.07598 2.58759 7.05092 2.53018 7.02549 2.48227C7.00004 2.43436 6.9618 2.3524 6.94049 2.30014C6.9192 2.24787 6.89255 2.19442 6.8813 2.18135C6.87003 2.16829 6.85521 2.14026 6.84836 2.11905C6.84148 2.09784 6.80665 2.02517 6.77092 1.95754C6.7352 1.88991 6.70598 1.82989 6.70598 1.82414C6.70598 1.81508 6.62999 1.66404 6.59088 1.59537C6.55297 1.52885 6.46897 1.35571 6.43777 1.27988C6.40183 1.19249 6.38109 1.14875 6.24944 0.882676C6.20849 0.799925 6.15779 0.689458 6.13677 0.637194C6.11575 0.58493 6.09188 0.531478 6.08373 0.518412C6.0553 0.472863 5.98512 0.324307 5.98512 0.309657C5.98512 0.301533 5.95018 0.250757 5.90747 0.196799C5.80499 0.0673269 5.68789 0.00940896 5.51214 0.00125262C5.42212 -0.00291266 5.37139 0.00299485 5.31925 0.0237262Z" fill="#EF4444" />
  </svg>
)

export default function ProfilePage() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const dispatch = useDispatch()
  const user = useSelector((s: RootState) => s.auth.user)
  const apiUser = useSelector((s: RootState) => s.auth.apiUser)
  const displayName = useSelector((s: RootState) => s.auth.displayName)
  const referralCode = useSelector((s: RootState) => s.auth.referralCode) || apiUser?.referralCode
  const currentLanguage = useSelector((s: RootState) => s.language.current)
  const { t } = useTranslation()
  const [isAvatarSheetOpen, setIsAvatarSheetOpen] = useState(false)
  const [selectedAvatar, setSelectedAvatar] = useState<number | null>(null)
  const [tempSelectedAvatar, setTempSelectedAvatar] = useState<number | null>(null)
  const [selectedTab, setSelectedTab] = useState<'crown' | 'friends' | 'settings' | 'favorites'>(() => {
    if (typeof window === 'undefined') return 'crown'
    const tabParam = searchParams.get('tab')
    if (tabParam === 'crown' || tabParam === 'friends' || tabParam === 'settings' || tabParam === 'favorites') {
      return tabParam
    }
    const stored = window.localStorage.getItem('profileSelectedTab')
    if (stored === 'crown' || stored === 'friends' || stored === 'settings' || stored === 'favorites') {
      return stored
    }
    return 'crown'
  })
  const [selectedTransaction, setSelectedTransaction] = useState<typeof MOCK_TRANSACTIONS[0] | null>(null)
  const { data: allSeries, loading: seriesLoading } = useSeriesList()
  const [favoriteIds, setFavoriteIds] = useState<string[]>([])
  const [referrals, setReferrals] = useState<any[]>([])
  const [referralsLoading, setReferralsLoading] = useState(false)
  const accessToken = useSelector((s: RootState) => s.auth.accessToken)

  useEffect(() => {
    const stored = localStorage.getItem('favorites')
    if (stored) {
      try {
        setFavoriteIds(JSON.parse(stored))
      } catch (e) {
        setFavoriteIds([])
      }
    }
  }, [])

  useEffect(() => {
    const fetchProfile = async () => {
      if (!accessToken || apiUser) return
      
      try {
        const profile = await getUserProfile(accessToken)
        if (profile) {
          const user: any = {
            id: profile.telegramId,
            username: profile.username || undefined,
            first_name: profile.displayName?.split(' ')[0] || undefined,
            last_name: profile.displayName?.split(' ').slice(1).join(' ') || undefined
          }
          dispatch(setUser(user))
          dispatch(setApiUser(profile))
          if (profile.referralCode) {
            dispatch(setReferralCode(profile.referralCode))
          }
        }
      } catch (error) {
        console.error('Failed to fetch profile:', error)
      }
    }

    fetchProfile()
  }, [accessToken, apiUser, dispatch])

  useEffect(() => {
    const fetchReferrals = async () => {
      if (!accessToken || selectedTab !== 'friends') return
      
      setReferralsLoading(true)
      try {
        const data = await getUserReferrals(accessToken)
        setReferrals(data.referrals || [])
      } catch (error) {
        console.error('Failed to fetch referrals:', error)
      } finally {
        setReferralsLoading(false)
      }
    }

    fetchReferrals()
  }, [accessToken, selectedTab])

  useEffect(() => {
    if (typeof window === 'undefined') return
    window.localStorage.setItem('profileSelectedTab', selectedTab)
  }, [selectedTab])

  const handleTabChange = (tab: 'crown' | 'friends' | 'settings' | 'favorites') => {
    setSelectedTab(tab)
    const query = tab === 'crown' ? '' : `?tab=${tab}`
    router.replace(`/profile${query}`)
  }

  const favoriteSeries = allSeries?.filter(series => favoriteIds.includes(series._id)) || []

  const handleAvatarClick = () => {
    setTempSelectedAvatar(selectedAvatar)
    setIsAvatarSheetOpen(true)
  }

  const handleAvatarSelect = (avatarId: number) => {
    setTempSelectedAvatar(avatarId)
  }

  const handleConfirmAvatar = () => {
    setSelectedAvatar(tempSelectedAvatar)
    setIsAvatarSheetOpen(false)
  }

  const openFaq = () => dispatch(openModal({ name: 'faq' }))

  const selectedAvatarData = selectedAvatar ? AVATARS.find(a => a.id === selectedAvatar) : null
  const balance = apiUser?.crowns || 0
  return (
    <main className="w-full relative min-h-screen app-frame">
      <img
        src="/profile-top-bg.png"
        alt=""
        className="absolute inset-0 -top-13 left-1/2 -translate-x-1/2 right-0 w-[80%] h-full object-contain object-top pointer-events-none opacity-50"
        style={{ zIndex: 2 }}
      />
      <section className="px-4 relative z-10">
        <div className="flex flex-col items-center mt-8">
          <button
            onClick={handleAvatarClick}
            className="w-[103px] h-[103px] rounded-full overflow-hidden flex items-center justify-center bg-black border border-white/10 active:scale-95 transition-transform relative"
          >
            {selectedAvatarData ? (
              <img
                src={selectedAvatarData.url}
                alt="Avatar"
                className="w-full h-full object-cover"
                onError={(e) => {
                  const target = e.target as HTMLImageElement
                  target.style.display = 'none'
                }}
              />
            ) : (
              <DefaultAvatarIcon />
            )}
          </button>

          <div className="mt-4 text-center">
            <div className="text-lg font-semibold text-white">
              {displayName || apiUser?.displayName || user?.first_name || user?.username || ''}
            </div>
            {(user?.username || apiUser?.username) && (
              <div className="text-sm text-white/70 mt-1">
                @{apiUser?.username || user?.username}
              </div>
            )}
          </div>

          <div className="mt-6  flex items-center justify-center relative">
            <button
              onClick={() => handleTabChange('crown')}
              className="flex flex-col items-center gap-1"
            >
              <div className={selectedTab === 'crown' ? 'opacity-100' : 'opacity-80'}>
                <CrownIconSVG isSelected={selectedTab === 'crown'} />
              </div>
              <div className={`mt-1 ${selectedTab === 'crown' ? 'opacity-100' : 'opacity-0'}`}>
                <SelectionLine />
              </div>
            </button>
            <button
              onClick={() => handleTabChange('friends')}
              className="flex flex-col items-center gap-1"
            >
              <div className={selectedTab === 'friends' ? 'opacity-100' : 'opacity-80'}>
                <ReferralsIconSVG isSelected={selectedTab === 'friends'} />
              </div>
              <div className={`mt-1 ${selectedTab === 'friends' ? 'opacity-100' : 'opacity-0'}`}>
                <SelectionLine />
              </div>
            </button>
            <button
              onClick={() => handleTabChange('settings')}
              className="flex flex-col items-center gap-1"
            >
              <div className={selectedTab === 'settings' ? 'opacity-100' : 'opacity-80'}>
                <SettingsIcon isSelected={selectedTab === 'settings'} />
              </div>
              <div className={`mt-1 ${selectedTab === 'settings' ? 'opacity-100' : 'opacity-0'}`}>
                <SelectionLine />
              </div>
            </button>
            <button
              onClick={() => handleTabChange('favorites')}
              className="flex flex-col items-center gap-1"
            >
              <div className={selectedTab === 'favorites' ? 'opacity-100' : 'opacity-80'}>
                <FavoritesIconSVG isSelected={selectedTab === 'favorites'} />
              </div>
              <div className={`mt-1 ${selectedTab === 'favorites' ? 'opacity-100' : 'opacity-0'}`}>
                <SelectionLine />
              </div>
            </button>

          </div>
        </div>
      </section>

      {selectedTab === 'crown' && (
        <>
          <section className="px-4 mt-6 relative z-10">
            <div
              style={{
                background: 'linear-gradient(to top, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 80%)',
                borderRadius: '9px',
                pointerEvents: 'none',
                padding: '1px'
              }}
            >
              <div
                className="rounded-[8px] p-4 h-full w-full flex items-center justify-between relative overflow-hidden"
                style={{
                  backgroundColor: 'rgba(20, 16, 38, 0.9)'
                }}
              >
                <div className="text-white/80 text-sm">{t('profile.crownBalance')}</div>
                <div className="text-lg font-semibold flex items-center gap-1 text-white">
                  {balance} <CrownIcon className="w-5 h-5" />
                </div>
              </div>
            </div>
          </section>

          <section className="px-8 mt-4 relative z-10">
            <div className="flex items-center justify-between mb-3">
              <div className="text-white font-medium text-base">{t('profile.transactionHistory')}</div>
              <button
                onClick={() => router.push('/profile/transactions')}
                className="text-white/70 text-sm flex items-center gap-1"
              >
                {t('profile.allTransactions')}
                <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M1 1L5 5L1 9" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
              </button>
            </div>
            <div className="space-y-0">
              {MOCK_TRANSACTIONS.length === 0 ? (
                <div
                  style={{
                    background: 'linear-gradient(to top, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 80%)',
                    borderRadius: '9px',
                    pointerEvents: 'none',
                    padding: '1px'
                  }}
                >
                  <div
                    className="rounded-[8px] px-4 py-3 h-full w-full text-sm text-white/80 text-center relative overflow-hidden"
                    style={{
                      backgroundColor: 'rgba(20, 16, 38, 0.9)'
                    }}
                  >
                    {t('profile.noTransactions')}
                  </div>
                </div>
              ) : (
                MOCK_TRANSACTIONS.slice(0, 5).map((transaction) => (
                  <button
                    key={transaction.id}
                    onClick={() => setSelectedTransaction(transaction)}
                    className="w-full flex items-center justify-between py-3 border-b border-[#261f3f] last:border-0 text-left"
                  >
                    <div className="text-white text-sm">{transaction.description}</div>
                    <div
                      className={`text-sm font-medium flex items-center gap-1 ${transaction.amount > 0 ? 'text-[#8F37FF]' : 'text-red-500'
                        }`}
                    >
                      {transaction.amount > 0 ? '+' : ''}
                      {transaction.amount}{' '}
                      {transaction.amount > 0 ? (
                        <CrownIcon className="w-4 h-4" />
                      ) : (
                        <RedCrownIcon className="w-4 h-4" />
                      )}
                    </div>
                  </button>
                ))
              )}
            </div>
          </section>
        </>
      )}

      {selectedTab === 'friends' && (
        <>
          <section className="px-4 mt-6 relative z-10">
            <div
              className="rounded-[12px] border border-white/10 p-4 relative overflow-hidden"
              style={{
                background: "rgba(0, 0, 0, 0.5)"

              }}
            >
              <div className="flex items-center justify-between">
                <div className="flex-1">
                  <div className="text-white font-medium text-base mb-1">
                    {t('profile.inviteFriends')}
                  </div>
                  <div className="text-white/90 text-sm">
                    {t('profile.inviteDescription')}
                  </div>
                </div>
                <div className="flex items-center gap-1 bg-gradient-to-r from-[#B49AFA] to-[#704ED7] rounded-[8px] px-3 py-1.5">
                  <span className="text-white font-semibold text-xl">+5</span>
                  <svg width="30" height="24" viewBox="0 0 30 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fillRule="evenodd" clipRule="evenodd" d="M14.1561 0.0694568C14.0525 0.114754 13.9431 0.177437 13.913 0.208779C13.8828 0.240167 13.8338 0.265805 13.8041 0.265805C13.7468 0.265805 13.519 0.524466 13.519 0.589468C13.519 0.610563 13.4486 0.757349 13.3625 0.915634C13.2764 1.07396 13.1941 1.25242 13.1796 1.31227C13.1652 1.37213 13.1252 1.44538 13.0908 1.47501C13.0564 1.50468 13.0283 1.55994 13.0283 1.59778C13.0283 1.63566 12.9696 1.79477 12.8978 1.95144C12.826 2.1081 12.7536 2.29364 12.7368 2.36374C12.72 2.43385 12.6931 2.49124 12.6769 2.49124C12.6607 2.49124 12.5991 2.62166 12.5398 2.78101C12.4806 2.94041 12.4057 3.1037 12.3733 3.14399C12.3409 3.18424 12.3144 3.24117 12.3144 3.27047C12.3144 3.32713 12.1786 3.65121 11.9307 4.18624C11.8473 4.36627 11.7791 4.53063 11.7791 4.55149C11.7791 4.61093 11.5019 5.18096 11.4598 5.20795C11.4391 5.22125 11.4221 5.27058 11.4221 5.31755C11.4221 5.36452 11.3418 5.5661 11.2437 5.76556C11.1455 5.96501 11.0652 6.14486 11.0652 6.16521C11.0652 6.20063 10.9931 6.36615 10.6155 7.19712C10.5228 7.40112 10.4136 7.65148 10.3729 7.75348C10.2395 8.0878 10.0202 8.57861 9.82718 8.9746C9.72292 9.18856 9.63757 9.38969 9.63757 9.42158C9.63757 9.45348 9.59742 9.53262 9.54834 9.59749C9.49927 9.6623 9.45911 9.74631 9.45911 9.78415C9.45911 9.95138 9.19914 10.4169 8.97116 10.6577C8.81461 10.8231 8.28352 11.1218 8.07553 11.1613C7.81226 11.2113 7.44089 11.1379 7.10865 10.97C6.94139 10.8856 6.79452 10.8052 6.78225 10.7914C6.7528 10.7586 6.44702 10.5273 5.97919 10.1844C5.77062 10.0314 5.56338 9.8746 5.51864 9.83589C5.47393 9.79713 5.38863 9.74617 5.32902 9.72262C5.26946 9.69911 5.22074 9.65989 5.22074 9.63546C5.22074 9.61107 5.1756 9.57644 5.12036 9.55849C5.06513 9.5406 4.9569 9.47138 4.8798 9.40471C4.73025 9.27531 4.61756 9.18666 4.46061 9.07483C4.40693 9.03658 4.29223 8.94789 4.20572 8.87779C4.11926 8.80764 4.02985 8.75029 4.00705 8.75029C3.98426 8.75029 3.89164 8.67745 3.80125 8.58844C3.71086 8.49937 3.61534 8.42635 3.58893 8.42616C3.56256 8.42593 3.49381 8.37359 3.43617 8.30984C3.37853 8.24609 3.31709 8.19393 3.29965 8.19393C3.27092 8.19393 2.90727 7.94445 2.59006 7.70712C2.52189 7.65612 2.33808 7.52208 2.18152 7.40923C2.02502 7.29643 1.81461 7.13471 1.71392 7.04992C1.61323 6.96512 1.51507 6.89576 1.49576 6.89576C1.47648 6.89576 1.4378 6.86326 1.40987 6.82357C1.34059 6.72509 0.815922 6.68369 0.595482 6.75931C0.334176 6.84893 0.0581909 7.17009 0.0209825 7.42792C-0.0349193 7.81547 -0.00136942 8.0145 0.400562 9.67756C0.52691 10.2003 0.680517 10.8471 0.741951 11.1148C0.80334 11.3826 0.890293 11.7477 0.935131 11.9262C0.980013 12.1047 1.05033 12.4385 1.09142 12.668C1.13251 12.8975 1.20465 13.2313 1.25167 13.4098C1.29874 13.5883 1.37851 13.943 1.42897 14.198C1.47947 14.453 1.53925 14.7346 1.56187 14.8239C1.58449 14.9131 1.61572 15.0696 1.63129 15.1716C1.64686 15.2736 1.67823 15.3806 1.70107 15.4093C1.72391 15.438 1.76643 15.6362 1.79561 15.8497C1.82479 16.0633 1.86481 16.2498 1.88453 16.2643C1.90429 16.2787 1.95051 16.4561 1.98727 16.6583C2.02403 16.8606 2.07668 17.0887 2.10425 17.1652C2.13182 17.2417 2.17024 17.4086 2.18964 17.5361C2.23238 17.8169 2.30426 18.1496 2.3917 18.4711C2.42753 18.6029 2.51515 18.9784 2.58635 19.3056C2.6576 19.6329 2.74871 20.0467 2.78877 20.2252C2.82888 20.4037 2.89192 20.7062 2.92895 20.8975C3.06623 21.6074 3.09166 21.7104 3.14626 21.7784C3.177 21.8166 3.21381 21.9522 3.22804 22.0797C3.29612 22.6897 3.4579 23.0275 3.77916 23.2308C4.12082 23.4469 4.51793 23.4701 5.15382 23.3112C5.70419 23.1737 6.1763 23.0673 6.49225 23.0096C6.90061 22.935 7.45071 22.824 7.80838 22.744C7.94334 22.7138 8.13406 22.685 8.23222 22.68C8.33037 22.6749 8.4709 22.6565 8.54452 22.6392C8.93195 22.5475 9.06548 22.525 9.39219 22.4963C9.58849 22.479 9.83079 22.4468 9.93064 22.4246C10.1989 22.3653 11.9269 22.2067 12.6713 22.1732C14.2374 22.1025 17.8372 22.1909 18.0138 22.3043C18.0345 22.3176 18.2253 22.3329 18.4376 22.3382C18.6499 22.3435 18.93 22.3656 19.0601 22.3873C19.3491 22.4355 19.5276 22.4585 20.0884 22.5196C20.3276 22.5456 20.6086 22.5983 20.713 22.6366C20.8173 22.6748 21.0432 22.7181 21.215 22.7326C21.3868 22.7472 21.6478 22.7794 21.795 22.8042C21.9422 22.8289 22.1831 22.8683 22.3304 22.8917C22.564 22.9289 23.1576 23.0541 23.6465 23.1695C23.7324 23.1897 23.903 23.228 24.0257 23.2544C24.1484 23.281 24.309 23.3336 24.3826 23.3714C24.4918 23.4276 24.5906 23.4322 24.918 23.397C25.1388 23.3732 25.3262 23.3331 25.3344 23.3079C25.3426 23.2826 25.3768 23.262 25.4103 23.262C25.4949 23.262 25.7667 22.9625 25.8671 22.7586C25.9129 22.6657 25.9859 22.4228 26.0294 22.2188C26.0729 22.0148 26.1367 21.7263 26.1713 21.5776C26.2058 21.4289 26.2341 21.2669 26.2341 21.2177C26.2341 21.1684 26.2517 21.0918 26.2732 21.0475C26.3422 20.9057 26.4126 20.6395 26.4126 20.5204C26.4126 20.3942 26.6523 19.3592 26.7003 19.2787C26.7329 19.2238 26.7428 19.1751 26.7899 18.8385C26.8074 18.7134 26.8436 18.5569 26.8705 18.4908C26.9186 18.3724 26.9651 18.1595 27.0961 17.4575C27.1327 17.2613 27.1748 17.0806 27.1895 17.0559C27.2041 17.0311 27.2444 16.8683 27.2788 16.694C27.3423 16.3729 27.612 15.2255 27.7238 14.8007C27.7574 14.6732 27.8055 14.4646 27.8308 14.3371C27.8561 14.2096 27.9209 13.9175 27.9747 13.688C28.0902 13.1959 28.1318 12.9968 28.1974 12.6216C28.2242 12.4686 28.2652 12.3365 28.2885 12.328C28.3119 12.3195 28.3309 12.2465 28.3308 12.1657C28.3306 12.085 28.3596 11.925 28.3951 11.8103C28.4306 11.6955 28.524 11.2991 28.6027 10.9294C28.6813 10.5596 28.7745 10.1319 28.8096 9.97892C28.8448 9.82592 28.8988 9.57509 28.9296 9.42149C28.9604 9.26789 29.0172 9.02796 29.0558 8.88831C29.2824 8.06981 29.3323 7.51656 29.2076 7.20635C29.0885 6.91027 28.722 6.70785 28.2987 6.70446C28.0746 6.7027 27.989 6.72213 27.9142 6.79176C27.8613 6.84105 27.6975 6.95802 27.5502 7.05172C27.403 7.14542 27.1621 7.31544 27.0149 7.42958C26.8676 7.54373 26.7048 7.65649 26.6529 7.68018C26.601 7.70382 26.5465 7.75607 26.5316 7.79627C26.5168 7.83652 26.483 7.86939 26.4566 7.86939C26.4071 7.86939 25.8281 8.26793 25.7882 8.32954C25.7758 8.34864 25.6703 8.42176 25.5538 8.49214C25.4372 8.56247 25.3418 8.63536 25.3418 8.65418C25.3418 8.69053 24.9267 8.98211 24.8749 8.98211C24.858 8.98211 24.784 9.0447 24.7104 9.1212C24.6367 9.1977 24.5489 9.26029 24.5153 9.26029C24.4815 9.26029 24.4379 9.28778 24.4183 9.32144C24.3747 9.39618 23.9007 9.72392 23.8362 9.72392C23.8107 9.72392 23.6822 9.82787 23.5508 9.9549C23.4194 10.082 23.2868 10.1863 23.2561 10.1867C23.2255 10.1872 23.2003 10.2084 23.2003 10.2339C23.2003 10.2594 23.1721 10.2803 23.1377 10.2803C23.081 10.2803 22.9683 10.3654 22.5534 10.7216C22.3827 10.8681 22.1176 11.0111 21.8619 11.0946C21.6309 11.17 21.0589 11.1845 21.0589 11.1148C21.0589 11.0893 21.0438 11.0719 21.0254 11.0761C20.9454 11.0942 20.712 11.0007 20.5681 10.8928C20.2162 10.6289 19.8097 10.0343 19.8097 9.78359C19.8097 9.74608 19.7695 9.6623 19.7204 9.59749C19.6713 9.53262 19.6312 9.4424 19.6312 9.39697C19.6312 9.35153 19.6155 9.30744 19.5964 9.29891C19.5631 9.28416 19.2726 8.63823 19.2558 8.54165C19.2513 8.51615 19.2236 8.44972 19.1941 8.39403C19.1646 8.33831 19.1401 8.26528 19.1396 8.23176C19.1392 8.1982 19.0783 8.07802 19.0045 7.96466C18.9305 7.8513 18.8588 7.70526 18.845 7.64012C18.8313 7.57498 18.7646 7.40691 18.6969 7.26666C18.6292 7.12641 18.5274 6.88648 18.4707 6.73349C18.4141 6.58049 18.3431 6.42401 18.3132 6.38576C18.2832 6.34751 18.2438 6.26545 18.2255 6.20337C18.2072 6.14129 18.1145 5.92853 18.0195 5.73056C17.9244 5.53258 17.8466 5.35687 17.8466 5.34004C17.8466 5.31352 17.6444 4.87135 17.5403 4.67032C17.4394 4.47559 17.2159 3.96875 17.1328 3.74676C17.0372 3.49093 16.982 3.36287 16.6316 2.58397C16.5226 2.34172 16.3877 2.01834 16.3318 1.86534C16.2758 1.71234 16.2123 1.55586 16.1906 1.51761C16.115 1.38427 15.9282 0.949386 15.9282 0.9065C15.9282 0.882715 15.8352 0.734074 15.7215 0.576115C15.4488 0.197095 15.1372 0.0275441 14.6694 0.00366696C14.4299 -0.00852659 14.2949 0.00876722 14.1561 0.0694568Z" fill="white" />
                  </svg>
                </div>
              </div>
            </div>
          </section>

          {referralCode && (
            <section className="px-4 mt-4 relative z-10">
              <div
                className="rounded-[12px] border border-white/10 p-4 relative overflow-hidden"
                style={{
                  background: "rgba(0, 0, 0, 0.5)"
                }}
              >
                <div className="text-white font-medium text-base mb-2">
                  {t('profile.yourReferralCode')}
                </div>
                <div className="text-white/90 text-sm mb-3">
                  {referralCode}
                </div>
                <div className="text-white/70 text-xs">
                  {t('profile.shareReferralCode')}
                </div>
              </div>
            </section>
          )}

          <section className="px-4 mt-4 relative z-10">
            <button
              onClick={() => router.push('/profile/referrals/links')}
              className="w-full rounded-[12px] p-4 flex items-center justify-between"
              style={{
                background: 'linear-gradient(to bottom, #B49AFA 0%, #704ED7 100%)'
              }}
            >
              <div className="flex items-center gap-3">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10.1179 6.12373L8.8636 7.39387C9.48604 7.44404 10.0095 7.56008 10.4338 7.74198C10.8582 7.92388 11.2244 8.1685 11.5324 8.47584C12.0795 9.0278 12.4441 9.63465 12.6265 10.2964C12.8088 10.9581 12.8103 11.6182 12.6311 12.2768C12.4519 12.9354 12.0889 13.5376 11.5419 14.0832L8.45808 17.1504C7.91111 17.6961 7.30755 18.0599 6.64741 18.2418C5.98727 18.4237 5.32555 18.4252 4.66227 18.2465C3.99898 18.0677 3.39385 17.7055 2.84688 17.1598C2.2999 16.6079 1.93525 16.001 1.75292 15.3393C1.5706 14.6776 1.5706 14.0174 1.75292 13.3588C1.93525 12.7002 2.2999 12.0981 2.84688 11.5524L4.69528 9.70833C4.56325 9.41354 4.47994 9.09837 4.44536 8.7628C4.41078 8.42723 4.41864 8.10577 4.46894 7.79843L1.69634 10.5551C0.948177 11.3078 0.446783 12.1389 0.192156 13.0483C-0.0624705 13.9578 -0.0640423 14.8688 0.187441 15.7815C0.438924 16.6941 0.945035 17.5299 1.70577 18.2889C2.47279 19.0541 3.31369 19.5621 4.22846 19.813C5.14323 20.0639 6.05642 20.0623 6.96805 19.8083C7.87968 19.5543 8.70957 19.0541 9.45773 18.3077L12.683 15.0806C13.4374 14.3279 13.942 13.4968 14.1966 12.5873C14.4512 11.6779 14.4528 10.7668 14.2013 9.85419C13.9498 8.94156 13.4406 8.10577 12.6736 7.34682C12.3781 7.04575 12.0291 6.7933 11.6268 6.58945C11.2244 6.38559 10.7214 6.23035 10.1179 6.12373ZM9.88215 13.8763L11.1364 12.6061C10.514 12.556 9.99056 12.4399 9.56618 12.258C9.1418 12.0761 8.77558 11.8315 8.46752 11.5242C7.91425 10.9722 7.54646 10.3654 7.36414 9.70361C7.18181 9.0419 7.18181 8.38176 7.36414 7.72317C7.54646 7.06457 7.91111 6.46243 8.45808 5.91675L11.5324 2.84959C12.0857 2.3039 12.6924 1.94011 13.3526 1.75821C14.0127 1.57632 14.6729 1.57475 15.333 1.75351C15.9932 1.93227 16.5999 2.29763 17.1532 2.84959C17.7001 3.39528 18.0648 3.99899 18.2471 4.66071C18.4294 5.32244 18.4294 5.9826 18.2471 6.64119C18.0648 7.29978 17.7001 7.90192 17.1532 8.44761L15.3047 10.2917C15.4368 10.5927 15.5201 10.9095 15.5546 11.2419C15.5892 11.5744 15.5814 11.8942 15.5311 12.2016L18.3037 9.4449C19.0518 8.69223 19.5532 7.86115 19.8078 6.95167C20.0625 6.04219 20.064 5.13114 19.8126 4.21852C19.561 3.3059 19.0549 2.47011 18.2942 1.71117C17.5272 0.945948 16.6863 0.437892 15.7715 0.187C14.8568 -0.0638917 13.9436 -0.0623236 13.032 0.191704C12.1203 0.445732 11.2873 0.949086 10.5328 1.70176L7.31698 4.91945C6.56254 5.67212 6.058 6.5032 5.80337 7.41268C5.54874 8.32217 5.54717 9.23322 5.79866 10.1458C6.05014 11.0584 6.55939 11.8942 7.32642 12.6532C7.62191 12.9543 7.97084 13.2067 8.37321 13.4106C8.77558 13.6144 9.27856 13.7697 9.88215 13.8763Z" fill="white" />
                </svg>
                <span className="text-white font-medium">{t('profile.yourReferralLinks')}</span>
              </div>
              <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L5 5L1 9" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
          </section>

          <section className="px-8 mt-6 relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div className="text-white font-medium text-base">{t('profile.yourReferrals')}</div>
              <button
                onClick={() => router.push('/profile/referrals/all')}
                className="text-white/70 text-sm flex items-center gap-1"
              >
                {t('profile.allReferrals')}
                <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M1 1L5 5L1 9" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
              </button>
            </div>
            <div className="space-y-0">
              {referralsLoading ? (
                <div className="text-white/70 text-sm text-center py-4">{t('profile.loading')}</div>
              ) : referrals.length === 0 ? (
                <div
                  style={{
                    background: 'linear-gradient(to top, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 80%)',
                    borderRadius: '9px',
                    pointerEvents: 'none',
                    padding: '1px'
                  }}
                >
                  <div
                    className="rounded-[8px] px-4 py-3 h-full w-full text-sm text-white/80 text-center relative overflow-hidden"
                    style={{
                      backgroundColor: 'rgba(20, 16, 38, 0.9)'
                    }}
                  >
                    {t('profile.noReferrals')}
                  </div>
                </div>
              ) : (
                referrals.slice(0, 5).map((referral, index) => (
                  <div
                    key={index}
                    className="w-full flex items-center gap-3 py-3 border-b border-[#261f3f] last:border-0"
                  >
                    <div className="w-10 h-10 rounded-full bg-black border border-white/10 flex items-center justify-center overflow-hidden">
                      {referral.image ? (
                        <img src={referral.image} alt={referral.name} className="w-full h-full object-cover" />
                      ) : (
                        <DefaultAvatarIcon />
                      )}
                    </div>
                    <div className="flex-1">
                      <div className="text-white text-sm font-medium">{referral.name}</div>
                      <div className="text-white/70 text-xs">{referral.username ? `@${referral.username}` : ''}</div>
                    </div>
                  </div>
                ))
              )}
            </div>
            <div className="mt-4 text-white/70 text-xs">
              {t('profile.onlyWatchedAccounts')}
            </div>
          </section>
        </>
      )}

      {selectedTab === 'favorites' && (
        <section className="px-4 mt-6 relative z-10">
          {seriesLoading && (
            <div className="grid grid-cols-3 gap-4">
              {Array.from({ length: 6 }).map((_, i) => (
                <div key={i} className="animate-pulse">
                  <div className="w-full aspect-[3/4] bg-white/10 rounded-xl mb-2" />
                  <div className="h-4 bg-white/10 rounded w-3/4 mx-auto" />
                </div>
              ))}
            </div>
          )}

          {!seriesLoading && favoriteSeries.length > 0 && (
            <div className="grid grid-cols-3 gap-4">
              {favoriteSeries.map((item) => (
                <div
                  key={item._id}
                  onClick={() => router.push(`/series/${item._id}`)}
                  className="cursor-pointer active:scale-95 transition-transform"
                >
                  <img
                    src={`${API_BASE_URL}/${item.coverImage}`}
                    alt={item.title}
                    className="w-full aspect-[3/4] object-cover rounded-xl mb-2"
                  />
                  <h3 className="text-sm font-medium text-center text-white line-clamp-2">{item.title}</h3>
                </div>
              ))}
            </div>
          )}

          {!seriesLoading && favoriteSeries.length === 0 && (
            <div
              style={{
                background: 'linear-gradient(to top, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 80%)',
                borderRadius: '9px',
                pointerEvents: 'none',
                padding: '1px'
              }}
            >
              <div
                className="rounded-[8px] px-4 py-3 h-full w-full text-sm text-white/80 text-center relative overflow-hidden"
                style={{
                  backgroundColor: 'rgba(20, 16, 38, 0.9)'
                }}
              >
                {t('profile.noFavorites')}
              </div>
            </div>
          )}
        </section>
      )}

      {selectedTab === 'settings' && (
        <section className="px-4 mt-6 relative z-10">
          <div className="space-y-0">
            <button
              onClick={() => router.push('/profile/settings/name')}
              className="w-full flex items-center justify-between py-4 border-b border-[#261f3f] text-left"
            >
              <div>
                <div className="text-white text-base font-medium mb-1">
                  {t('profile.displayName')}
                </div>
                <div className="text-white/70 text-sm">
                  {displayName || apiUser?.displayName || user?.first_name || user?.username || ''}
                </div>
              </div>
              <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L5 5L1 9" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
            <button
              onClick={() => router.push('/profile/settings/language')}
              className="w-full flex items-center justify-between py-4 border-b border-[#261f3f] text-left"
            >
              <div>
                <div className="text-white text-base font-medium mb-1">
                  {t('profile.appLanguage')}
                </div>
                <div className="text-white/70 text-sm">
                  {t('profile.selectedLanguage')}: {languageNames[currentLanguage]}
                </div>
              </div>
              <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L5 5L1 9" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
            <button
              onClick={openFaq}
              className="w-full flex items-center justify-between py-4 border-b border-[#261f3f] last:border-0 text-left"
            >
              <div>
                <div className="text-white text-base font-medium mb-1">
                  {t('profile.faq')}
                </div>
                <div className="text-white/70 text-sm">
                  {t('profile.faqDescription')}
                </div>
              </div>
              <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L5 5L1 9" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
          </div>
        </section>
      )}

      <BottomSheet
        open={isAvatarSheetOpen}
        onClose={() => setIsAvatarSheetOpen(false)}
        title={t('profile.selectAvatar')}
      >
        <div className="flex flex-col items-center gap-6">
          <div className="flex gap-6 justify-center">
            {AVATARS.map((avatar) => {
              const currentSelected = tempSelectedAvatar !== null ? tempSelectedAvatar : selectedAvatar
              const isSelected = currentSelected === avatar.id
              return (
                <button
                  key={avatar.id}
                  onClick={() => handleAvatarSelect(avatar.id)}
                  className={`w-24 h-24 rounded-full overflow-hidden flex items-center justify-center transition-all relative ${isSelected
                    ? 'ring-2 ring-[#8F37FF]'
                    : ''
                    }`}
                >
                  <img
                    src={avatar.url}
                    alt={`Avatar ${avatar.id}`}
                    className="w-full h-full object-cover"
                    loading="eager"
                    onError={(e) => {
                      const target = e.target as HTMLImageElement
                      target.style.display = 'none'
                    }}
                  />
                </button>
              )
            })}
          </div>

          <button
            onClick={handleConfirmAvatar}
            disabled={tempSelectedAvatar === null}
            className="w-full h-12 rounded-full text-white font-medium flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            style={{
              background: tempSelectedAvatar !== null
                ? 'linear-gradient(135deg, #8F37FF 0%, #AC6BFF 100%)'
                : 'rgba(255, 255, 255, 0.1)',
              boxShadow: tempSelectedAvatar !== null
                ? '0 4px 20px rgba(143, 55, 255, 0.4)'
                : 'none'
            }}
            >
              {t('profile.chooseAvatar')}
            </button>
        </div>
      </BottomSheet>

      {selectedTransaction && (
        <TransactionDetailModal
          transaction={selectedTransaction}
          onClose={() => setSelectedTransaction(null)}
        />
      )}
    </main>
  )
}


